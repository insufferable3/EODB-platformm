{% extends "base.html" %}

{% block title %}Home - EODB Platform{% endblock %}

{% block content %}
    <section class="hero-section">
        <h2>Your One-Stop Platform for Startup Approvals & Schemes</h2>
        <p>Simplify your journey from idea to enterprise with AI-powered guidance and real-time tracking.</p>
        <button id="launchChatbotBtn" class="btn">Launch AI Assistant</button>
    </section>

    <section class="chatbot-section" style="display: none;">
        <h3>AI Assistant</h3>
        <div class="chat-window" id="chatWindow">
            <div class="chat-message bot-message">Hello! I'm your EODB AI assistant. How can I help you today?</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="Ask me about approvals, schemes, or your startup domain...">
            <button id="sendBtn" class="btn">Send</button>
        </div>
    </section>

    <section class="features-section">
        <h3>Key Features</h3>
        <div class="feature-cards">
            <a href="{{ url_for('all_guides') }}" class="feature-card-link">
                <div class="card card-with-button">
                    <h4>Step-by-Step Guidance</h4>
                    <p>Clear, actionable steps for every approval process.</p>
                    <button type="button" class="btn btn-small-card">Explore Guides</button>
                </div>
            </a>
            <div class="card">
                <h4>Real-time Tracking</h4>
                <p>Monitor your application status effortlessly.</p>
            </div>
            <div class="card card-with-button"> {# ADDED: card-with-button class #}
                <h4>Scheme Recommendations</h4>
                <p>Discover relevant government schemes and subsidies.</p>
                <button id="findSchemesBtn" class="btn btn-small-card" onclick="window.location.href='{{ url_for('find_schemes') }}'">Find Schemes</button> {# MOVED BUTTON INSIDE #}
            </div>
        </div>
    </section>
    
    {# DELETED: find-schemes-button-container pura section hata do #}


{% endblock %}

{% block scripts %}
<script>
    // --- Chatbot Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        const launchChatbotBtn = document.getElementById('launchChatbotBtn');
        const chatbotSection = document.querySelector('.chatbot-section');
        const chatWindow = document.getElementById('chatWindow');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        // Launch chatbot button click event
        if (launchChatbotBtn) { // Check if button exists
            launchChatbotBtn.addEventListener('click', () => {
                chatbotSection.style.display = 'block'; // Make chatbot visible
                launchChatbotBtn.style.display = 'none'; // Hide the launch button
                userInput.focus(); // Focus on the input field
            });
        }

        // Event listeners for sending messages in chatbot
        if (sendBtn) { // Check if button exists
            sendBtn.addEventListener('click', sendMessage);
        }
        if (userInput) { // Check if input exists
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function sendMessage() {
            const message = userInput.value.trim(); // Get user input and remove whitespace
            if (message === '') return; // Don't send empty messages

            // Display user's message
            const userMessageDiv = document.createElement('div');
            userMessageDiv.classList.add('chat-message', 'user-message');
            userMessageDiv.textContent = message;
            chatWindow.appendChild(userMessageDiv);

            // Scroll to bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;

            userInput.value = ''; // Clear input

            // Send message to Flask backend
            fetch('/ask_chatbot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                // Display bot response
                const botMessageDiv = document.createElement('div');
                botMessageDiv.classList.add('chat-message', 'bot-message');
                let botResponseHtml = data.response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                botMessageDiv.innerHTML = botResponseHtml.replace(/\n/g, '<br>');

                chatWindow.appendChild(botMessageDiv);

                // Display recommended approvals if any
                if (data.recommended_approvals && data.recommended_approvals.length > 0) {
                    const approvalsListDiv = document.createElement('div');
                    approvalsListDiv.classList.add('chat-message', 'bot-message', 'recommendation');
                    let ulContent = '<strong>Recommended for you:</strong><ul>';
                    data.recommended_approvals.forEach(app => {
                        ulContent += `<li><a href="${app.portal_link || '#'}" target="_blank">${app.name}</a></li>`;
                    });
                    ulContent += '</ul>';
                    approvalsListDiv.innerHTML = ulContent;
                    chatWindow.appendChild(approvalsListDiv);
                }

                // Scroll to bottom
                chatWindow.scrollTop = chatWindow.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.classList.add('chat-message', 'bot-message', 'error-message');
                errorDiv.textContent = 'Sorry, something went wrong. Please try again.';
                chatWindow.appendChild(errorDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });
        }
    });

    // --- Find Schemes Button Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        const findSchemesBtn = document.getElementById('findSchemesBtn');
        if (findSchemesBtn) {
            findSchemesBtn.addEventListener('click', () => {
                window.location.href = "{{ url_for('find_schemes') }}";
            });
        }
    });
</script>
{% endblock %}